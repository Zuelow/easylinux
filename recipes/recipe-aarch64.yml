# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
# EasyLinux - Repair Cafe Edition (aarch64/ARM64)
# A beginner-friendly Fedora Atomic distribution for repair cafes and maker spaces

name: easylinux-aarch64
description: A beginner-friendly Linux distribution - Repair Cafe Edition (ARM64)

base-image: quay.io/fedora/fedora-kinoite
image-version: 43

modules:
  # ============================================
  # SYSTEM PACKAGES
  # ============================================
  - type: rpm-ostree
    install:
      # Danish language support
      - glibc-langpack-da
      - langpacks-da

      # CLI tools
      - htop
      - fastfetch
      - fish
      - vim-enhanced
      - git

      # Hardware support
      - fwupd

      # Gaming (ARM-compatible only)
      - mangohud

      # Theming
      - papirus-icon-theme

      # KWin X11 for proper window decorations
      - kwin-x11

      # Plymouth boot splash
      - plymouth-theme-spinner

      # Calamares first-boot wizard
      - calamares
      - console-setup

      # Printing support
      - cups
      - cups-filters
      - system-config-printer
      - hplip
      - gutenprint
      - sane-backends
      - simple-scan

      # Multimedia codecs
      - gstreamer1-plugins-good
      - gstreamer1-plugins-bad-free
      - gstreamer1-plugins-ugly-free
      - gstreamer1-libav

      # Accessibility
      - orca
      - espeak-ng

  # ============================================
  # BRANDING & THEMES
  # ============================================
  - type: containerfile
    snippets:
      # Download repair cafe wallpapers from Unsplash to standard KDE location
      - |
        RUN mkdir -p /usr/share/wallpapers/RepairCafe && \
            curl -sL "https://images.unsplash.com/photo-1581092160607-ee22621dd758?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/workshop-tools.jpg && \
            curl -sL "https://images.unsplash.com/photo-1530124566582-a618bc2615dc?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/electronics-repair.jpg && \
            curl -sL "https://images.unsplash.com/photo-1504148455328-c376907d081c?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/soldering-work.jpg && \
            curl -sL "https://images.unsplash.com/photo-1572981779307-38b8cabb2407?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/vintage-tools.jpg && \
            curl -sL "https://images.unsplash.com/photo-1588508065123-287b28e013da?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/multimeter.jpg && \
            curl -sL "https://images.unsplash.com/photo-1518770660439-4636190af475?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/circuit-board.jpg && \
            curl -sL "https://images.unsplash.com/photo-1504917595217-d4dc5ebe6122?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/workbench.jpg && \
            curl -sL "https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/3d-printer.jpg && \
            curl -sL "https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/maker-space.jpg && \
            curl -sL "https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=3840&q=90" -o /usr/share/wallpapers/RepairCafe/tool-wall.jpg && \
            chmod 644 /usr/share/wallpapers/RepairCafe/*.jpg

      # Install full Steam Deck Vapor theme (complete look-and-feel)
      - |
        RUN curl -sL "https://steamdeck-packages.steamos.cloud/archlinux-mirror/jupiter-main/os/x86_64/steamdeck-kde-presets-0.29-1-any.pkg.tar.zst" -o /tmp/steamdeck.tar.zst && \
            zstd -d /tmp/steamdeck.tar.zst && \
            tar -xf /tmp/steamdeck.tar -C /tmp && \
            cp -r /tmp/usr/share/color-schemes/* /usr/share/color-schemes/ && \
            cp -r /tmp/usr/share/plasma/desktoptheme/* /usr/share/plasma/desktoptheme/ && \
            cp -r /tmp/usr/share/plasma/look-and-feel/* /usr/share/plasma/look-and-feel/ && \
            rm -rf /tmp/steamdeck* /tmp/usr /tmp/etc

      # Install Redmond 2K color scheme (Windows 2000 style)
      - |
        RUN printf '[ColorEffects:Disabled]\nColor=56,56,56\nColorAmount=0\nColorEffect=0\nContrastAmount=0.65\nContrastEffect=1\nIntensityAmount=0.1\nIntensityEffect=2\n\n[ColorEffects:Inactive]\nChangeSelectionColor=true\nColor=112,111,110\nColorAmount=0.025\nColorEffect=2\nContrastAmount=0.1\nContrastEffect=2\nEnable=false\n\n[Colors:Button]\nBackgroundAlternate=212,208,200\nBackgroundNormal=212,208,200\nDecorationFocus=0,0,128\nDecorationHover=10,36,106\nForegroundActive=0,0,0\nForegroundInactive=128,128,128\nForegroundLink=0,0,255\nForegroundNegative=255,0,0\nForegroundNeutral=255,128,0\nForegroundNormal=0,0,0\nForegroundPositive=0,128,0\nForegroundVisited=128,0,128\n\n[Colors:Selection]\nBackgroundAlternate=10,36,106\nBackgroundNormal=10,36,106\nDecorationFocus=10,36,106\nDecorationHover=10,36,106\nForegroundActive=255,255,255\nForegroundInactive=255,255,255\nForegroundLink=255,255,0\nForegroundNegative=255,0,0\nForegroundNeutral=255,128,0\nForegroundNormal=255,255,255\nForegroundPositive=0,255,0\nForegroundVisited=255,128,255\n\n[Colors:Tooltip]\nBackgroundAlternate=255,255,225\nBackgroundNormal=255,255,225\nForegroundNormal=0,0,0\n\n[Colors:View]\nBackgroundAlternate=245,245,245\nBackgroundNormal=255,255,255\nDecorationFocus=0,0,128\nDecorationHover=10,36,106\nForegroundActive=0,0,0\nForegroundInactive=128,128,128\nForegroundLink=0,0,255\nForegroundNegative=255,0,0\nForegroundNeutral=255,128,0\nForegroundNormal=0,0,0\nForegroundPositive=0,128,0\nForegroundVisited=128,0,128\n\n[Colors:Window]\nBackgroundAlternate=212,208,200\nBackgroundNormal=212,208,200\nDecorationFocus=0,0,128\nDecorationHover=10,36,106\nForegroundActive=0,0,0\nForegroundInactive=128,128,128\nForegroundLink=0,0,255\nForegroundNegative=255,0,0\nForegroundNeutral=255,128,0\nForegroundNormal=0,0,0\nForegroundPositive=0,128,0\nForegroundVisited=128,0,128\n\n[General]\nColorScheme=Redmond2K\nName=Redmond 2K\nshadeSortColumn=true\n\n[WM]\nactiveBackground=10,36,106\nactiveBlend=255,255,255\nactiveForeground=255,255,255\ninactiveBackground=128,128,128\ninactiveBlend=128,128,128\ninactiveForeground=212,208,200\n' > /usr/share/color-schemes/Redmond2K.colors

      # Danish locale and timezone
      - |
        RUN echo "LANG=da_DK.UTF-8" > /etc/locale.conf && \
            echo "KEYMAP=dk" > /etc/vconsole.conf && \
            ln -sf /usr/share/zoneinfo/Europe/Copenhagen /etc/localtime && \
            mkdir -p /etc/X11/xorg.conf.d && \
            printf 'Section "InputClass"\n    Identifier "system-keyboard"\n    MatchIsKeyboard "on"\n    Option "XkbLayout" "dk"\nEndSection\n' > /etc/X11/xorg.conf.d/00-keyboard.conf

      # KDE Plasma defaults - Full Steam Deck Vapor look-and-feel
      - |
        RUN mkdir -p /etc/skel/.config && \
            printf '[Layout]\nLayoutList=dk\nModel=pc105\nUse=true\n' > /etc/skel/.config/kxkbrc && \
            printf '[General]\nColorScheme=Vapor\n\n[Icons]\nTheme=breeze-dark\n\n[KDE]\nLookAndFeelPackage=com.valve.vapor.desktop\nwidgetStyle=Breeze\n' > /etc/skel/.config/kdeglobals && \
            printf '[Theme]\nname=Vapor\n' > /etc/skel/.config/plasmarc && \
            printf '[org.kde.kdecoration2]\nlibrary=org.kde.breeze\ntheme=__aurorae__svg__ActiveAccentFrame\nButtonsOnLeft=\nButtonsOnRight=IAX\nCloseOnDoubleClickOnMenu=false\n\n[WindowSwitcher]\nLayoutName=org.kde.breeze.desktop\n\n[DesktopSwitcher]\nLayoutName=org.kde.breeze.desktop\n\n[Effect-overview]\nBorderActivate=9\n\n[Effect-windowview]\nBorderActivateAll=7\n\n[Plugins]\nblurEnabled=true\ncontrastEnabled=true\nslideEnabled=false\n\n[Windows]\nBorderlessMaximizedWindows=true\n' > /etc/skel/.config/kwinrc && \
            printf '[KSplash]\nTheme=com.valve.vapor\n' > /etc/skel/.config/ksplashrc && \
            printf '[Containments][1][Wallpaper][org.kde.image][General]\nImage=file:///usr/share/wallpapers/RepairCafe/electronics-repair.jpg\n' > /etc/skel/.config/plasma-org.kde.plasma.desktop-appletsrc

      # Configure SDDM login screen
      - |
        RUN mkdir -p /etc/sddm.conf.d && \
            printf '[Theme]\nCurrent=breeze\n\n[General]\nInputMethod=\n' > /etc/sddm.conf.d/easylinux.conf

      # Configure Plymouth boot splash
      - |
        RUN plymouth-set-default-theme spinner 2>/dev/null || true

      # OS release branding
      - |
        RUN sed -i 's/PRETTY_NAME=.*/PRETTY_NAME="EasyLinux (Repair Cafe Edition)"/' /usr/lib/os-release && \
            sed -i 's/NAME=.*/NAME="EasyLinux"/' /usr/lib/os-release && \
            echo 'VARIANT="Repair Cafe Edition"' >> /usr/lib/os-release && \
            echo 'VARIANT_ID=repaircafe' >> /usr/lib/os-release

      # Firefox policies - uBlock Origin and useful bookmarks
      - |
        RUN mkdir -p /etc/firefox/policies && \
            printf '{\n  "policies": {\n    "ExtensionSettings": {\n      "uBlock0@raymondhill.net": {\n        "install_url": "https://addons.mozilla.org/firefox/downloads/latest/ublock-origin/latest.xpi",\n        "installation_mode": "normal_installed"\n      }\n    },\n    "DisplayBookmarksToolbar": "always",\n    "NoDefaultBookmarks": true,\n    "Bookmarks": [\n      {"Title": "iFixit Repair Guides", "URL": "https://www.ifixit.com/Guide", "Placement": "toolbar"},\n      {"Title": "Repair Cafe", "URL": "https://www.repaircafe.org/", "Placement": "toolbar"},\n      {"Title": "KDE User Guide", "URL": "https://userbase.kde.org/", "Placement": "toolbar"},\n      {"Title": "Flathub Apps", "URL": "https://flathub.org/", "Placement": "toolbar"}\n    ],\n    "Homepage": {\n      "URL": "https://www.repaircafe.org/",\n      "StartPage": "homepage"\n    }\n  }\n}\n' > /etc/firefox/policies/policies.json

      # Desktop icons for easy access
      - |
        RUN mkdir -p /etc/skel/Desktop && \
            printf '[Desktop Entry]\nVersion=1.0\nType=Link\nName=Documents\nIcon=folder-documents\nURL=$HOME/Documents\n' > /etc/skel/Desktop/documents.desktop && \
            printf '[Desktop Entry]\nVersion=1.0\nType=Application\nName=App Store\nComment=Install and manage applications\nIcon=system-software-install\nExec=plasma-discover\nTerminal=false\nCategories=System;\n' > /etc/skel/Desktop/appstore.desktop && \
            printf '[Desktop Entry]\nVersion=1.0\nType=Application\nName=System Rollback\nComment=Restore previous system version if something breaks\nIcon=system-reboot\nExec=konsole -e bash -c \"echo EasyLinux System Rollback; echo =====================; echo; echo This will restore your system to the previous version.; echo Your files will NOT be affected.; echo; read -p Press_Enter_to_continue...; sudo rpm-ostree rollback; echo; echo Done! Please reboot to complete the rollback.; read -p Press_Enter_to_close...\"\nTerminal=false\nCategories=System;\n' > /etc/skel/Desktop/rollback.desktop && \
            chmod +x /etc/skel/Desktop/*.desktop

      # Night Light (blue light filter) enabled by default
      - |
        RUN printf '[NightColor]\nActive=true\nMode=Times\nNightTemperature=4500\nEveningBeginFixed=2000\nMorningBeginFixed=0600\n' > /etc/skel/.config/kwinrc.nightlight && \
            cat /etc/skel/.config/kwinrc.nightlight >> /etc/skel/.config/kwinrc && \
            rm /etc/skel/.config/kwinrc.nightlight

      # Larger fonts and icons for accessibility (11pt instead of 10pt)
      - |
        RUN sed -i 's/\[General\]/[General]\nfont=Noto Sans,11,-1,5,50,0,0,0,0,0\nfixed=Hack,11,-1,5,50,0,0,0,0,0\nsmallestReadableFont=Noto Sans,9,-1,5,50,0,0,0,0,0\ntoolBarFont=Noto Sans,10,-1,5,50,0,0,0,0,0\nmenuFont=Noto Sans,11,-1,5,50,0,0,0,0,0\n/' /etc/skel/.config/kdeglobals

      # Enable automatic Flatpak updates
      - |
        RUN mkdir -p /etc/systemd/user && \
            printf '[Unit]\nDescription=Update Flatpak applications\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/flatpak update -y --noninteractive\n\n[Install]\nWantedBy=default.target\n' > /etc/systemd/user/flatpak-update.service && \
            printf '[Unit]\nDescription=Daily Flatpak update\n\n[Timer]\nOnCalendar=daily\nPersistent=true\nRandomizedDelaySec=3600\n\n[Install]\nWantedBy=timers.target\n' > /etc/systemd/user/flatpak-update.timer && \
            mkdir -p /etc/skel/.config/systemd/user/timers.target.wants && \
            ln -sf /etc/systemd/user/flatpak-update.timer /etc/skel/.config/systemd/user/timers.target.wants/flatpak-update.timer

      # Enable automatic system updates (rpm-ostree)
      - |
        RUN systemctl enable rpm-ostreed-automatic.timer

      # Welcome HTML page
      - |
        RUN mkdir -p /usr/share/easylinux && \
            printf '<!DOCTYPE html>\n<html lang="da">\n<head>\n<meta charset="UTF-8">\n<title>Velkommen til EasyLinux</title>\n<style>\nbody{font-family:sans-serif;max-width:800px;margin:50px auto;padding:20px;background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;min-height:100vh;}\nh1{color:#7dd3fc;text-align:center;}\n.card{background:rgba(255,255,255,0.1);border-radius:15px;padding:20px;margin:20px 0;}\n.card h2{color:#7dd3fc;margin-top:0;}\na{color:#7dd3fc;}\n.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;}\n.btn{display:block;background:#7dd3fc;color:#1a1a2e;text-decoration:none;padding:15px;border-radius:10px;text-align:center;font-weight:bold;}\n.btn:hover{background:#fff;}\n</style>\n</head>\n<body>\n<h1>Velkommen til EasyLinux!</h1>\n<div class="card">\n<h2>Kom godt i gang</h2>\n<p>EasyLinux er designet til at vaere nem at bruge. Her er nogle tips:</p>\n<ul>\n<li><strong>Apps:</strong> Klik paa App Store ikonet paa skrivebordet for at installere programmer</li>\n<li><strong>Filer:</strong> Dine dokumenter gemmes i Dokumenter-mappen</li>\n<li><strong>Opdateringer:</strong> Systemet opdaterer sig selv automatisk</li>\n<li><strong>Problemer?</strong> Brug System Rollback ikonet til at gaa tilbage til en tidligere version</li>\n</ul>\n</div>\n<div class="card">\n<h2>Nyttige links</h2>\n<div class="grid">\n<a href="https://www.repaircafe.org/" class="btn">Repair Cafe</a>\n<a href="https://www.ifixit.com/Guide" class="btn">iFixit Guides</a>\n<a href="https://flathub.org/" class="btn">Find Apps</a>\n<a href="https://userbase.kde.org/" class="btn">KDE Hjaelp</a>\n</div>\n</div>\n<div class="card">\n<h2>Tastaturgenveje</h2>\n<ul>\n<li><strong>Super (Windows-tast):</strong> Aaben programmenuen</li>\n<li><strong>Super + E:</strong> Aaben filhaandtering</li>\n<li><strong>Alt + Tab:</strong> Skift mellem vinduer</li>\n<li><strong>Super + D:</strong> Vis skrivebord</li>\n</ul>\n</div>\n</body>\n</html>\n' > /usr/share/easylinux/welcome.html

      # Welcome desktop icon
      - |
        RUN printf '[Desktop Entry]\nVersion=1.0\nType=Application\nName=Velkommen til EasyLinux\nComment=Getting started guide\nIcon=help-contents\nExec=xdg-open /usr/share/easylinux/welcome.html\nTerminal=false\nCategories=Documentation;\n' > /etc/skel/Desktop/welcome.desktop && \
            chmod +x /etc/skel/Desktop/welcome.desktop

      # Autostart welcome page on first login
      - |
        RUN mkdir -p /etc/skel/.config/autostart && \
            printf '[Desktop Entry]\nVersion=1.0\nType=Application\nName=EasyLinux Welcome\nExec=sh -c "if [ ! -f ~/.easylinux-welcomed ]; then xdg-open /usr/share/easylinux/welcome.html && touch ~/.easylinux-welcomed; fi"\nHidden=false\nNoDisplay=true\nX-GNOME-Autostart-enabled=true\n' > /etc/skel/.config/autostart/easylinux-welcome.desktop

  # ============================================
  # CALAMARES FIRST-BOOT WIZARD
  # ============================================
  - type: containerfile
    snippets:
      # Copy Calamares configuration
      - |
        COPY calamares/settings.conf /usr/share/calamares-easylinux/settings.conf
        COPY calamares/modules/ /usr/share/calamares-easylinux/modules/
        COPY calamares/branding/ /usr/share/calamares-easylinux/branding/

      # Install firstboot service and setup script
      - |
        COPY calamares/setup.sh /usr/libexec/easylinux-firstboot/setup.sh
        COPY calamares/easylinux-firstboot.service /usr/lib/systemd/system/easylinux-firstboot.service
        RUN chmod +x /usr/libexec/easylinux-firstboot/setup.sh && \
            systemctl enable easylinux-firstboot.service

  # ============================================
  # DEFAULT FLATPAKS
  # ============================================
  - type: default-flatpaks
    configurations:
      - scope: system
        repo:
          name: flathub
          title: Flathub
          url: https://dl.flathub.org/repo/flathub.flatpakrepo
        notify: true
        install:
          # Essential apps
          - org.mozilla.firefox
          - org.libreoffice.LibreOffice
          - org.videolan.VLC
          - org.gnome.Calculator
          - org.kde.okular

          # Communication
          - md.obsidian.Obsidian
          - org.signal.Signal

          # Utilities
          - io.github.flattool.Warehouse
          - com.github.tchx84.Flatseal

          # Backup solution
          - org.gnome.World.PikaBackup

          # Repair Cafe / Maker apps
          - org.kicad.KiCad
          - org.freecadweb.FreeCAD
          - org.blender.Blender
          - org.gimp.GIMP
          - org.inkscape.Inkscape
          - org.gnome.SimpleScan
